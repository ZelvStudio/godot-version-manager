#!/usr/bin/env python3

import sys
import subprocess
import os
from os.path import basename, splitext, expanduser
import argparse

INSTALL_DIR = '/usr/bin/godot'
SAVE_DIR = expanduser('~/.godot/')

os.makedirs(SAVE_DIR,exist_ok=True)


def extract_archive(file: str) -> str:
    """Extracts Godot archive to /tmp and return extracted file path"""
    subprocess.run(['unzip', file, '-d', '/tmp'])
    return '/tmp/' + basename(splitext(file)[0])


def add_archive(godot_file: str) -> str:
    if godot_file.endswith('.zip'):
        godot_file = extract_archive(godot_file)
    # make Godot executable
    subprocess.run(['chmod', '+x', godot_file])
    # add to the list of managed versions
    print(f'Saving a copy to {SAVE_DIR}{basename(godot_file)}')
    subprocess.run(['mv', godot_file, SAVE_DIR])
    return os.path.join(SAVE_DIR,basename(godot_file))


def get_current_version() -> str:
    return get_version('godot')


def get_version(app_path: str) -> str:
    return subprocess.check_output([app_path, '--version']).decode('utf-8').strip()


def list_versions() -> list[str]:
    """List existing Godot applications"""
    saved_versions = os.listdir(SAVE_DIR)
    displayed_list = []
    for app in saved_versions:
        app_version = get_version(os.path.join(SAVE_DIR,app))
        if app_version == get_current_version():
            app_version = f'-> {app_version}'
        else:
            app_version = f'   {app_version}'
        displayed_list.append(app_version)
    print('\n'.join(displayed_list))




# Instantiate the parser
parser = argparse.ArgumentParser(description='Install Godot and manage versions')

# Make arguments mutually exclusive
exclusive_group = parser.add_mutually_exclusive_group()

# Install archive file
exclusive_group.add_argument('-i', '--install', metavar=('archive'),
                    help='install Godot app (can be a zip file)')

# Add archive file without installing
exclusive_group.add_argument('-a', '--add', metavar=('archive'),
                    help='add Godot app to the managed versions without installing (can be a zip file)')

# Optional listing of available Godot version
exclusive_group.add_argument('-l', '--list', action='store_true',
                    help=f'list available Godot apps in {SAVE_DIR}')

# Parse arguments
args = parser.parse_args()




if args.list:
    list_versions()
    exit()

if args.add:
    add_archive(args.add)

if args.install:
    godot_file = add_archive(args.install)

    print(f'Installing to {INSTALL_DIR}')
    subprocess.run(['sudo', 'cp', godot_file, INSTALL_DIR])
